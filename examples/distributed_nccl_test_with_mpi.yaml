resources:
  accelerators: T4
  cloud: gcp

file_mounts:
  ~/.ssh/id_rsa: ~/.ssh/sky-key

num_nodes: 2

setup: |
  sudo mv /etc/apt/sources.list.d/kubernetes.list /etc/apt/sources.list.d/kubernetes.list.save || true
  sudo apt update
  sudo apt -y install git
  # install MPI (optional, if you intend to use multiple GPUs)
  sudo apt install -y openmpi-bin openmpi-doc libopenmpi-dev
  # install nccl
  pip install nvidia-nccl-cu12
  export LIBRARY_PATH=$LIBRARY_PATH:/usr/local/nccl2/lib
  echo $LIBRARY_PATH
  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/
  echo $LD_LIBRARY_PATH
  export CPLUS_INCLUDE_PATH=$CPLUS_INCLUDE_PATH:/usr/local/nccl2/include
  git clone https://github.com/NVIDIA/nccl-tests.git
  cd ./nccl-tests
  make MPI=1 NCCL_HOME=/usr/local/nccl2 MPI_HOME=/usr/lib/openmpi

run: |
  export PATH=/usr/lib/openmpi/bin:$PATH
  export LD_LIBRARY_PATH=/usr/lib/openmpi/lib:$LD_LIBRARY_PATH

  cd ./nccl-tests
  NCCL_TEST_PATH=$(pwd)/build/all_reduce_perf
  HOST_IPS=$(echo "$SKYPILOT_NODE_IPS" | tr '\n' ",")
  HOST_IPS=${HOST_IPS%,}
  echo $HOST_IPS
  MASTER_IP=$(echo "$SKYPILOT_NODE_IPS" | head -n1)

  if [ "$SKYPILOT_NODE_RANK" == "0" ]; then
    mpirun -np $SKYPILOT_NUM_NODES \
      --allow-run-as-root \
      -H $HOST_IPS \
      -x MASTER_ADDR=$MASTER_IP \
      -x MASTER_PORT=12354 \
      -mca orte_base_help_aggregate 0 \
      -map-by node \
      --mca btl_tcp_if_exclude lo,docker0 \
      -mca plm_base_verbose 5 \
      -x PATH \
      $NCCL_TEST_PATH -b 8 -e 16 -f 2 -g $SKYPILOT_NUM_GPUS_PER_NODE
  fi
    
